<!DOCTYPE html>
<html lang="hr">
<head>
<meta charset="utf-8">
<meta name="viewport" content="width=device-width, initial-scale=1">
<title>‚ôªÔ∏è Mjerenje odlagali≈°nih plinova</title>
<script src="https://cdn.sheetjs.com/xlsx-0.20.0/package/dist/xlsx.full.min.js"></script>
<style>
:root {
  --primary: #2e7d32;
  --primary-light: #4caf50;
  --secondary: #ff9800;
  --light-bg: #f5f7fa;
  --card-shadow: 0 4px 8px rgba(0,0,0,0.1);
}
body {
  max-width: 900px;
  margin: 30px auto;
  font-family: 'Segoe UI', Tahoma, Geneva, Verdana, sans-serif;
  color: #333;
  font-size: 16px;
  padding: 15px;
  background: url('https://i.ibb.co/twvg0167/background.jpg') no-repeat center center fixed;
  background-size: cover;
}
.screen {
  display: none;
  background: rgba(255,255,255,0.92);
  border-radius: 12px;
  padding: 25px;
  box-shadow: var(--card-shadow);
  margin-bottom: 25px;
  border: 2px solid var(--primary);
  position: relative;
  overflow: hidden;
}
.screen::before {
  content: '';
  position: absolute;
  top: 0; left: 0; right: 0;
  height: 5px;
  background: var(--primary);
}
.login-header, .topbar {
  text-align: center;
  margin-bottom: 25px;
}
.logo {
  display: block;
  margin: 0 auto 15px;
  max-width: 300px;
  filter: drop-shadow(0 2px 4px rgba(0,0,0,0.1));
}
h1, h2, h3 {
  color: var(--primary);
  margin-top: 0;
}
select, input, button, textarea {
  width: 100%;
  padding: 14px;
  margin-bottom: 18px;
  border: 1px solid #ddd;
  border-radius: 8px;
  font-size: 16px;
  box-sizing: border-box;
  transition: all 0.3s;
}
select:focus, input:focus, textarea:focus {
  border-color: var(--primary);
  box-shadow: 0 0 0 2px rgba(46, 125, 50, 0.2);
  outline: none;
}
button {
  background-color: var(--primary);
  color: white;
  font-weight: bold;
  border: none;
  cursor: pointer;
  transition: background-color 0.3s;
  padding: 14px;
  border-radius: 8px;
  font-size: 16px;
}
button:hover {
  background-color: var(--primary-light);
  transform: translateY(-2px);
  box-shadow: 0 4px 8px rgba(0,0,0,0.15);
}
button.secondary {
  background-color: var(--secondary);
}
button.secondary:hover {
  background-color: #f57c00;
}
.success-message {
  background-color: var(--primary);
  color: white;
  padding: 12px;
  border-radius: 8px;
  text-align: center;
  margin: 15px 0;
  display: none;
}
.warning-message {
  background-color: #fff3f3;
  color: #c00;
  padding: 12px;
  border-radius: 8px;
  margin: 15px 0;
  text-align: center;
  display: none;
  border: 1px solid #ffcdd2;
}
.button-group {
  display: flex;
  gap: 10px;
  margin-top: 20px;
}
.button-group button {
  flex: 1;
}
.vent-table {
  width: 100%;
  border-collapse: collapse;
  margin-top: 20px;
  font-size: 14px;
  box-shadow: var(--card-shadow);
  border-radius: 8px;
  overflow: hidden;
}
.vent-table th, .vent-table td {
  border: 1px solid #e0e0e0;
  padding: 8px;
  text-align: center;
}
.vent-table th {
  background-color: var(--primary);
  color: white;
}
.form-group {
  display: grid;
  grid-template-columns: 1fr 1fr;
  gap: 10px;
  margin-bottom: 10px;
}
.form-group > div {
  display: flex;
  flex-direction: column;
}
.status-group {
  display: flex;
  gap: 15px;
  margin: 10px 0;
  align-items: center;
}
textarea {
  min-height: 80px;
  resize: vertical;
}
.history-item {
  background: white;
  border: 1px solid #eee;
  border-radius: 10px;
  padding: 15px;
  margin-bottom: 15px;
  box-shadow: var(--card-shadow);
  transition: all 0.3s;
}
.history-item:hover {
  transform: translateY(-3px);
  box-shadow: 0 6px 12px rgba(0,0,0,0.1);
}
#landfill-map {
  display: block;
  width: 100%;
  max-height: 400px;
  object-fit: contain;
  margin: 20px 0;
  border-radius: 8px;
  border: 1px solid #ddd;
}
#vent-form {
  display: none;
  background: white;
  padding: 20px;
  border-radius: 10px;
  box-shadow: 0 5px 15px rgba(0,0,0,0.2);
  margin: 20px 0;
  border: 2px solid var(--primary);
}
.topbar {
  display: flex;
  justify-content: flex-end;
  margin-bottom: 15px;
}
.topbar button {
  width: auto;
  padding: 10px 20px;
  font-size: 15px;
  background: var(--secondary);
}
.login-container {
  max-width: 500px;
  margin: 0 auto;
}
.device-selector {
  margin: 20px 0;
  padding: 15px;
  background: #e8f5e9;
  border-radius: 10px;
  border-left: 4px solid var(--primary);
}
.device-dropdown-label {
  font-size: 15px;
  color: #222;
  font-weight: 500;
  margin-bottom: 7px;
  display: block;
}
.device-dropdown {
  position: relative;
  margin-bottom: 18px;
}
.device-dropdown-selected {
  border: 1px solid #ddd;
  border-radius: 8px;
  padding: 12px 14px;
  background: #fff;
  cursor: pointer;
  display: flex;
  align-items: center;
  min-height: 48px;
  transition: border-color 0.2s;
}
.device-dropdown-selected img {
  width: 38px;
  height: 32px;
  object-fit: contain;
  border-radius: 5px;
  margin-right: 12px;
  border: 1px solid #eee;
  background: #fafafa;
}
.device-dropdown-list {
  position: absolute;
  left: 0; right: 0; top: 110%;
  background: #fff;
  border: 1px solid #ddd;
  border-radius: 8px;
  box-shadow: 0 4px 12px rgba(0,0,0,0.09);
  z-index: 100;
  display: none;
  max-height: 220px;
  overflow-y: auto;
  padding: 0;
  margin: 0;
}
.device-dropdown-list.open { display: block; }
.device-dropdown-option {
  display: flex;
  align-items: center;
  padding: 10px 14px;
  cursor: pointer;
  transition: background 0.15s;
  border-bottom: 1px solid #f2f2f2;
  background: #fff;
  font-size: 16px;
}
.device-dropdown-option:last-child { border-bottom: none; }
.device-dropdown-option:hover, .device-dropdown-option.selected {
  background: #e8f5e9;
}
.device-dropdown-option img {
  width: 38px;
  height: 32px;
  object-fit: contain;
  border-radius: 5px;
  margin-right: 12px;
  border: 1px solid #eee;
  background: #fafafa;
}
.device-dropdown-arrow {
  margin-left: auto;
  font-size: 18px;
  color: #888;
  pointer-events: none;
}
.login-footer {
  text-align: center;
  margin-top: 25px;
  font-size: 14px;
  color: #666;
}
#history-list .history-item .button-group {
  margin-top: 15px;
}
#add-vent-btn {
  margin: 15px 0;
  background: #2196F3;
}
#add-vent-btn:hover {
  background: #0b7dda;
}
.grid-container {
  display: grid;
  grid-template-columns: repeat(auto-fill, minmax(160px, 1fr));
  gap: 15px;
  margin-bottom: 20px;
}
.landfill-card {
  border: 1px solid #ddd;
  border-radius: 10px;
  padding: 15px;
  text-align: center;
  background: white;
  cursor: pointer;
  transition: all 0.3s;
  box-shadow: var(--card-shadow);
  position: relative;
  overflow: hidden;
}
.landfill-card.selected {
  border: 2px solid var(--primary);
  background-color: #f0fff0;
}
.landfill-card img {
  width: 100%;
  height: 90px;
  object-fit: cover;
  border-radius: 6px;
  margin-bottom: 10px;
  border: 1px solid #eee;
}
.time-select-group {
  display: flex;
  gap: 8px;
  align-items: center;
}
.time-select-group select {
  width: auto;
  min-width: 70px;
  margin-bottom: 0;
}
#vent-select-modal {
  display: none;
  position: fixed;
  z-index: 2000;
  left: 0; top: 0; right: 0; bottom: 0;
  background: rgba(0,0,0,0.33);
  align-items: center;
  justify-content: center;
}
#vent-select-modal .modal-content {
  background: #fff;
  border-radius: 10px;
  padding: 30px 25px 20px 25px;
  min-width: 250px;
  box-shadow: 0 8px 32px rgba(0,0,0,0.18);
  text-align: center;
}
#vent-select-modal select {
  width: 100%;
  margin-bottom: 18px;
}
#vent-select-modal button {
  width: 100%;
}
#landfill-name-display {
  text-align: center;
  margin-top: 0;
  margin-bottom: 10px;
  font-size: 2rem;
  color: var(--primary);
}
#manual-vent-modal {
  display: none;
  position: fixed;
  z-index: 2100;
  left: 0; top: 0; right: 0; bottom: 0;
  background: rgba(0,0,0,0.33);
  align-items: center;
  justify-content: center;
}
#manual-vent-modal .modal-content {
  background: #fff;
  border-radius: 10px;
  padding: 30px 25px 20px 25px;
  min-width: 250px;
  box-shadow: 0 8px 32px rgba(0,0,0,0.18);
  text-align: center;
}
#manual-vent-modal input {
  width: 100%;
  margin-bottom: 18px;
}
#notes-section {
  background: #f8fafb;
  border-radius: 12px;
  box-shadow: 0 2px 8px rgba(46,125,50,0.08);
  margin: 35px 0 0 0;
  padding: 24px 18px 32px 18px;
  border: 2px solid #4caf50;
  max-width: 900px;
}
#notes-section h2 {
  color: var(--primary);
  margin-top: 0;
  margin-bottom: 18px;
  font-size: 1.5rem;
  text-align: center;
  letter-spacing: 0.5px;
}
#notes-table {
  width: 100%;
  border-collapse: collapse;
  margin-top: 16px;
  background: white;
  border-radius: 8px;
  overflow: hidden;
  box-shadow: var(--card-shadow);
}
#notes-table th, #notes-table td {
  border: 1px solid #e0e0e0;
  padding: 10px 8px;
  text-align: left;
  font-size: 15px;
}
#notes-table th {
  background: var(--primary);
  color: white;
  font-weight: 500;
}
#notes-table td img {
  max-width: 80px;
  max-height: 60px;
  border-radius: 6px;
  border: 1px solid #ddd;
  margin-top: 4px;
  display: block;
  cursor: pointer;
}
.add-note-btn {
  background: var(--secondary);
  color: #fff;
  font-weight: bold;
  border: none;
  border-radius: 8px;
  padding: 12px 24px;
  font-size: 16px;
  margin: 0 auto 18px auto;
  display: block;
  transition: background 0.2s;
  cursor: pointer;
}
.add-note-btn:hover {
  background: #f57c00;
}
.note-form-row input[type="date"],
.note-form-row textarea {
  width: 100%;
  padding: 8px;
  margin-bottom: 8px;
  border-radius: 6px;
  border: 1px solid #bbb;
  font-size: 15px;
}
.note-form-row input[type="file"] {
  margin-bottom: 8px;
}
.note-form-row button {
  background: var(--primary);
  color: #fff;
  border: none;
  border-radius: 7px;
  padding: 8px 18px;
  font-size: 15px;
  margin-top: 6px;
  cursor: pointer;
}
.note-form-row button:hover {
  background: var(--primary-light);
}
.notes-empty {
  text-align: center;
  color: #888;
  padding: 18px 0;
  font-size: 16px;
}
.img-modal {
  display: none;
  position: fixed;
  z-index: 3000;
  left: 0; top: 0; right: 0; bottom: 0;
  background: rgba(0,0,0,0.75);
  align-items: center;
  justify-content: center;
}
.img-modal-content {
  background: none;
  border-radius: 10px;
  padding: 0;
  box-shadow: 0 8px 32px rgba(0,0,0,0.18);
  text-align: center;
  max-width: 90vw;
  max-height: 90vh;
  display: flex;
  flex-direction: column;
  align-items: center;
}
.img-modal-content img {
  max-width: 85vw;
  max-height: 80vh;
  border-radius: 8px;
  box-shadow: 0 2px 12px #222;
}
.img-modal-close {
  margin-top: 18px;
  background: #fff;
  color: #2e7d32;
  font-weight: bold;
  border: none;
  border-radius: 7px;
  padding: 8px 18px;
  font-size: 17px;
  cursor: pointer;
  box-shadow: 0 2px 8px #2222;
}
.img-modal-close:hover {
  background: #e0e0e0;
}
.note-delete-btn {
  background: #c0392b;
  color: #fff;
  font-weight: bold;
  border: none;
  border-radius: 7px;
  padding: 6px 13px;
  font-size: 14px;
  cursor: pointer;
  margin-left: 10px;
}
.note-delete-btn:hover {
  background: #e74c3c;
}
</style>
</head>
<body>
<!-- Login Screen -->
<div class="screen" id="login-screen">
  <div class="login-header">
    <img alt="Logo tvrtke" class="logo" crossorigin="anonymous" src="https://i.ibb.co/S7sTH9Tn/download-removebg-preview-removebg-preview.png">
    <h1>‚ôªÔ∏è Mjerenje odlagali≈°nih plinova</h1>
  </div>
  <div class="login-container">
    <form id="login-form">
      <label>Odaberite mjeritelja:</label>
      <select id="measurer-select" required>
        <option value="">Odaberite mjeritelja</option>
      </select>
      <div class="device-selector">
        <span class="device-dropdown-label">Kori≈°teni ureƒëaj za mjerenje:</span>
        <div id="device-dropdown" class="device-dropdown" tabindex="0"></div>
        <input type="hidden" id="device-select" name="device-select" required>
      </div>
      <button type="submit">Nastavi</button>
    </form>
    <div class="login-footer">
      <p>Sustav za praƒáenje emisija plinova iz odlagali≈°ta otpada</p>
      <button id="go-to-history" style="margin-top:20px;background:#e67e22;">üìú Povijest mjerenja</button>
    </div>
  </div>
  <!-- Bilje≈°ke i napomene odmah ispod gumba Povijest mjerenja -->
  <div id="notes-section">
    <h2>üìù Bilje≈°ke i napomene</h2>
    <button class="add-note-btn" onclick="toggleNoteForm()">+ Dodaj bilje≈°ku</button>
    <div id="note-form-row" class="note-form-row" style="display:none;">
      <form id="note-form" autocomplete="off">
        <label for="note-date">Datum:</label>
        <input type="date" id="note-date" required>
        <label for="note-text">Bilje≈°ka / Napomena:</label>
        <textarea id="note-text" rows="3" maxlength="500" placeholder="Upi≈°i bilje≈°ku ili napomenu..." required></textarea>
        <label for="note-image">Slika (opcionalno):</label>
        <input type="file" id="note-image" accept="image/*">
        <button type="submit">Spremi bilje≈°ku</button>
        <button type="button" onclick="toggleNoteForm()" style="background:#bbb;margin-left:8px;">Odustani</button>
      </form>
    </div>
    <table id="notes-table">
      <thead>
        <tr>
          <th style="width:120px;">Datum</th>
          <th>Bilje≈°ke / Napomene</th>
          <th style="width:110px;">Slika</th>
          <th style="width:60px;">Akcija</th>
        </tr>
      </thead>
      <tbody id="notes-table-body">
        <!-- Bilje≈°ke ƒáe se dinamiƒçki prikazivati ovdje -->
      </tbody>
    </table>
    <div id="notes-empty" class="notes-empty" style="display:none;">Nema unesenih bilje≈°ki.</div>
  </div>
</div>
<!-- Modal za prikaz slike -->
<div id="img-modal" class="img-modal" onclick="closeImgModal(event)">
  <div class="img-modal-content" onclick="event.stopPropagation();">
    <img id="img-modal-img" src="" alt="Bilje≈°ka slika">
    <button class="img-modal-close" onclick="closeImgModal(event)">Zatvori</button>
  </div>
</div>
<!-- Odabir odlagali≈°ta -->
<div class="screen" id="template-landfill-screen">
  <div class="topbar">
    <button onclick="resetToLogin()" type="button">Povratak na naslovnu</button>
  </div>
  <h2>Odaberite odlagali≈°te:</h2>
  <div class="grid-container" id="landfill-grid"></div>
  <div class="warning-message" id="template-landfill-warning"></div>
  <div class="button-group">
    <button id="template-landfill-next">Nastavi na mjerenje</button>
  </div>
</div>
<!-- Novo mjerenje -->
<div class="screen" id="new-measurement">
  <div class="topbar">
    <button onclick="resetToLogin()" type="button">Povratak na naslovnu</button>
  </div>
  <h1>Novo mjerenje</h1>
  <form id="measurement-form">
    <div class="form-group">
      <div>
        <label>Datum:</label>
        <input id="measurement-date" required type="date">
      </div>
      <div>
        <label>Vrijeme poƒçetka:</label>
        <div class="time-select-group">
          <select id="start-hour" required>
            <option value="">Sat</option>
          </select>
          <span>:</span>
          <select id="start-minute" required>
            <option value="">Min</option>
          </select>
        </div>
      </div>
    </div>
    <div class="form-group">
      <div>
        <label>Temperatura zraka (¬∞C):</label>
        <input id="air-temp" required step="0.1" type="number">
      </div>
      <div>
        <label>Tlak zraka (hPa):</label>
        <input id="air-pressure" required step="0.1" type="number">
      </div>
    </div>
    <div class="form-group">
      <div>
        <label>Smjer vjetra:</label>
        <input id="wind-direction" required type="text">
      </div>
      <div>
        <label>Brzina vjetra (m/s):</label>
        <input id="wind-speed" required step="0.1" type="number">
      </div>
    </div>
    <div class="form-group">
      <div>
        <label>Promjer cijevi (mm):</label>
        <input id="pipe-diameter" required step="0.1" type="number">
      </div>
    </div>
    <div class="button-group">
      <button onclick="showScreen('template-landfill-screen')" type="button">Natrag</button>
      <button id="measurement-submit-btn" type="submit">Nastavi na unos odu≈°nika</button>
    </div>
  </form>
</div>
<!-- Vent Mapping -->
<div class="screen" id="vent-mapping">
  <div class="topbar">
    <button onclick="resetToLogin()" type="button">Povratak na naslovnu</button>
  </div>
  <h1 id="landfill-name-display"></h1>
  <img id="landfill-map" src="https://via.placeholder.com/800x500?text=Karta+odlagali≈°ta">
  <div style="display:flex;gap:10px;justify-content:center;margin-bottom:10px;">
    <button id="add-vent-btn" style="flex:1;">Unesi novi odu≈°nik</button>
  </div>
  <div class="success-message" id="success-message">
    Mjerenje uspje≈°no spremljeno! Podaci su pohranjeni.
  </div>
  <div class="warning-message" id="missing-vents-warning" style="display:none;"></div>
  <table class="vent-table">
    <thead>
      <tr>
        <th>Odu≈°nik</th>
        <th>CH‚ÇÑ (%)</th>
        <th>CO‚ÇÇ (%)</th>
        <th>O‚ÇÇ (%)</th>
        <th>H‚ÇÇ (ppm)</th>
        <th>H‚ÇÇS (ppm)</th>
        <th>Temp (¬∞C)</th>
        <th>Status</th>
        <th>Napomena</th>
      </tr>
    </thead>
    <tbody id="vent-list"></tbody>
  </table>
  <div class="button-group">
    <button onclick="showScreen('new-measurement')">Natrag</button>
    <button class="secondary" id="finish-measurement">Zavr≈°i mjerenje</button>
  </div>
  <!-- Modal za odabir odu≈°nika -->
  <div id="vent-select-modal">
    <div class="modal-content">
      <h2>Odaberi odu≈°nik</h2>
      <select id="vent-select-dropdown">
        <option value="">Odaberi odu≈°nik</option>
      </select>
      <button id="vent-select-confirm">Dalje</button>
      <button onclick="closeVentSelectModal()" style="margin-top:8px;background:#bbb;">Odustani</button>
      <div style="margin-top:16px;">
        <button id="manual-vent-open" style="background:#607d8b;">Ruƒçno unesi novi odu≈°nik</button>
      </div>
    </div>
  </div>
  <!-- Modal za ruƒçno dodavanje odu≈°nika -->
  <div id="manual-vent-modal">
    <div class="modal-content">
      <h2>Dodaj ruƒçno novi odu≈°nik</h2>
      <input id="manual-vent-input" type="text" placeholder="Naziv odu≈°nika">
      <button id="manual-vent-confirm">Dodaj</button>
      <button onclick="closeManualVentModal()" style="margin-top:8px;background:#bbb;">Odustani</button>
    </div>
  </div>
  <form id="vent-form">
    <h2>Podaci odu≈°nika</h2>
    <input id="vent-index" type="hidden" value="-1">
    <label>Naziv odu≈°nika:</label>
    <input id="vent-name" required type="text" readonly>
    <div class="form-group">
      <div>
        <label>CH‚ÇÑ [%]:</label>
        <input id="ch4" step="0.01" type="number">
      </div>
      <div>
        <label>CO‚ÇÇ [%]:</label>
        <input id="co2" step="0.01" type="number">
      </div>
      <div>
        <label>O‚ÇÇ [%]:</label>
        <input id="o2" step="0.01" type="number">
      </div>
      <div>
        <label>H‚ÇÇ [ppm]:</label>
        <input id="h2" type="number">
      </div>
      <div>
        <label>H‚ÇÇS [ppm]:</label>
        <input id="h2s" type="number">
      </div>
      <div>
        <label>Temp. odu≈°nika (¬∞C):</label>
        <input id="vent-temp" step="0.1" type="number">
      </div>
    </div>
    <label>Status:</label>
    <div class="status-group">
      <div>
        <input checked id="status-measured" name="vent-status" type="radio" value="measured">
        <label for="status-measured">Izmjeren</label>
      </div>
      <div>
        <input id="status-not-measurable" name="vent-status" type="radio" value="not_measurable">
        <label for="status-not-measurable">Ne mo≈æe se izmjeriti</label>
      </div>
    </div>
    <label>Napomena:</label>
    <textarea id="vent-note"></textarea>
    <div class="button-group">
      <button onclick="document.getElementById('vent-form').style.display='none'" type="button">Odustani</button>
      <button type="submit">Spremi odu≈°nik</button>
    </div>
  </form>
</div>
<!-- Povijest mjerenja -->
<div class="screen" id="measurement-history">
  <div class="topbar">
    <button onclick="resetToLogin()" type="button">Povratak na naslovnu</button>
  </div>
  <h1>Povijest mjerenja</h1>
  <div id="history-list"></div>
  <button onclick="resetToLogin()">Povratak na naslovnu</button>
</div>
<script>
// --- Custom device dropdown ---
const DEVICES = [
  {
    value: "Geotech GA5000",
    label: "Geotech GA5000",
    img: "https://i.ibb.co/rfpH9M6F/GA5000.jpg"
  },
  {
    value: "MRU Optima Biogas",
    label: "MRU Optima Biogas",
    img: "https://i.ibb.co/9HQ1Dbcz/Optima-Biogas.jpg"
  }
];
function renderDeviceDropdown() {
  const dropdown = document.getElementById('device-dropdown');
  dropdown.innerHTML = '';
  let selected = null;
  const hiddenInput = document.getElementById('device-select');
  const prevValue = hiddenInput.value;
  if (prevValue) selected = DEVICES.find(d => d.value === prevValue);
  let selectedDevice = selected || null;
  const selectedDiv = document.createElement('div');
  selectedDiv.className = 'device-dropdown-selected';
  selectedDiv.tabIndex = 0;
  selectedDiv.innerHTML = `
    ${selectedDevice ? `<img src="${selectedDevice.img}" alt="${selectedDevice.label}">` : ''}
    <span>${selectedDevice ? selectedDevice.label : 'Odaberite ureƒëaj'}</span>
    <span class="device-dropdown-arrow">&#9662;</span>
  `;
  dropdown.appendChild(selectedDiv);
  const list = document.createElement('div');
  list.className = 'device-dropdown-list';
  DEVICES.forEach(device => {
    const opt = document.createElement('div');
    opt.className = 'device-dropdown-option' + (selectedDevice && device.value === selectedDevice.value ? ' selected' : '');
    opt.innerHTML = `<img src="${device.img}" alt="${device.label}"><span>${device.label}</span>`;
    opt.addEventListener('click', function(e) {
      e.stopPropagation();
      selectedDiv.innerHTML = `<img src="${device.img}" alt="${device.label}"><span>${device.label}</span><span class="device-dropdown-arrow">&#9662;</span>`;
      hiddenInput.value = device.value;
      hiddenInput.dispatchEvent(new Event('change'));
      list.classList.remove('open');
      list.querySelectorAll('.device-dropdown-option').forEach(x=>x.classList.remove('selected'));
      opt.classList.add('selected');
    });
    list.appendChild(opt);
  });
  dropdown.appendChild(list);
  selectedDiv.addEventListener('click', function(e) {
    e.stopPropagation();
    list.classList.toggle('open');
  });
  dropdown.addEventListener('keydown', function(e){
    if (e.key === "Enter" || e.key === " ") {
      list.classList.toggle('open');
      e.preventDefault();
    }
    if (e.key === "Escape") {
      list.classList.remove('open');
    }
  });
  document.addEventListener('click', function(e){
    list.classList.remove('open');
  });
}
renderDeviceDropdown();
// --- Bilje≈°ke i napomene (pohrana u localStorage) ---
function getNotes() {
  return JSON.parse(localStorage.getItem('notes') || '[]');
}
function saveNotes(notes) {
  localStorage.setItem('notes', JSON.stringify(notes));
}
function renderNotesTable() {
  const notes = getNotes();
  const tbody = document.getElementById('notes-table-body');
  const emptyDiv = document.getElementById('notes-empty');
  tbody.innerHTML = '';
  if (!notes.length) {
    emptyDiv.style.display = 'block';
    return;
  }
  emptyDiv.style.display = 'none';
  notes.sort((a, b) => b.date.localeCompare(a.date));
  notes.forEach((note, idx) => {
    const tr = document.createElement('tr');
    const tdDate = document.createElement('td');
    tdDate.textContent = note.date;
    tr.appendChild(tdDate);
    const tdText = document.createElement('td');
    tdText.textContent = note.text;
    tr.appendChild(tdText);
    const tdImg = document.createElement('td');
    if (note.image) {
      const img = document.createElement('img');
      img.src = note.image;
      img.alt = "Bilje≈°ka slika";
      img.style.cursor = "pointer";
      img.onclick = function(e) {
        openImgModal(note.image);
        e.stopPropagation();
      };
      tdImg.appendChild(img);
    } else {
      tdImg.textContent = '-';
    }
    tr.appendChild(tdImg);
    const tdAction = document.createElement('td');
    const delBtn = document.createElement('button');
    delBtn.className = 'note-delete-btn';
    delBtn.textContent = 'Obri≈°i';
    delBtn.onclick = function(e) {
      e.stopPropagation();
      if (confirm("≈Ωeli≈° li obrisati ovu bilje≈°ku?")) {
        const notesArr = getNotes();
        notesArr.splice(idx, 1);
        saveNotes(notesArr);
        renderNotesTable();
      }
    };
    tdAction.appendChild(delBtn);
    tr.appendChild(tdAction);
    tbody.appendChild(tr);
  });
}
function toggleNoteForm() {
  const row = document.getElementById('note-form-row');
  row.style.display = row.style.display === 'none' ? 'block' : 'none';
  if (row.style.display === 'block') {
    document.getElementById('note-date').value = '';
    document.getElementById('note-text').value = '';
    document.getElementById('note-image').value = '';
  }
}
document.addEventListener('DOMContentLoaded', function() {
  renderNotesTable();
});
document.getElementById('note-form').addEventListener('submit', function(e) {
  e.preventDefault();
  const date = document.getElementById('note-date').value;
  const text = document.getElementById('note-text').value.trim();
  const imageInput = document.getElementById('note-image');
  if (!date || !text) return;
  const note = { date, text, image: '' };
  if (imageInput.files && imageInput.files[0]) {
    const reader = new FileReader();
    reader.onload = function(evt) {
      note.image = evt.target.result;
      const notes = getNotes();
      notes.push(note);
      saveNotes(notes);
      renderNotesTable();
      toggleNoteForm();
    };
    reader.readAsDataURL(imageInput.files[0]);
  } else {
    const notes = getNotes();
    notes.push(note);
    saveNotes(notes);
    renderNotesTable();
    toggleNoteForm();
  }
});
// --- Modal za prikaz slike ---
function openImgModal(src) {
  document.getElementById('img-modal-img').src = src;
  document.getElementById('img-modal').style.display = 'flex';
}
function closeImgModal(e) {
  e.preventDefault();
  document.getElementById('img-modal').style.display = 'none';
  document.getElementById('img-modal-img').src = '';
}
// --- Ostatak aplikacije ---
const MEASURERS = [
  'Kristijan Li≈°ƒçinski',
  'Sven Jambru≈°iƒá',
  'Gordan Golja',
  'Luka Gu≈°tin',
  'Tomislav Haramba≈°iƒá'
];
const VENTS_BY_LANDFILL = {
  1: ["1", "2", "3", "4", "5", "6", "7", "8", "9", "10", "11", "12", "13", "14", "15", "16", "17", "18", "19", "20", "21"],
  2: ["A1", "A2", "A4", "A6", "A7", "A8", "B3", "Z1", "Z2", "Z3", "Z4", "Z5", "Z6", "Z7", "Z8", "Z9", "Z10", "Z11", "Z12", "Z13", "Z14", "Z15", "Z16", "Z17", "Z18", "Z19"],
  3: ["1-3", "2-2", "2-3", "2-4", "3-2", "3-3", "3-4", "4-2", "4-3", "4-4", "5-2", "5-3", "5-4", "6-2", "6-3", "6-4", "10-1", "10-2", "10-3", "10-4", "10-5", "9-1", "9-2", "9-3", "9-4", "9-5", "8-1", "8-2", "8-3", "8-4", "8-5"],
  4: ["N1", "N2", "N3", "N4"],
  5: ["01", "02", "03", "04", "05", "06", "07", "08", "09", "10", "12", "13", "14", "15", "16", "17", "18", "19", "20", "21", "22"],
  6: ["Z1", "Z2", "Z3", "Z4", "Z5", "Z6", "Z7", "Z8", "Z9", "Z10", "Z11", "Z12", "Z13", "Z14", "Z15", "Z16", "Z17", "Z18", "Z19", "Z20", "Z21"],
  7: ["1", "6", "7", "8", "9", "10"],
  8: ["1", "2", "3", "4", "5", "6", "Z1", "Z2", "N01", "N02", "N03", "N04", "N05", "N06", "N07", "N08", "N09", "N10", "N11" ],
  9: [],
  10: [],
  11: ["1", "2", "3", "4", "5", "6", "7"],
  12: ["1", "2", "3", "4", "5", "6", "7"],
};
const LANDFILLS = [
  { id: 1, name: 'Odlagali≈°te otpada Kri≈æevci', image: 'https://i.ibb.co/gXj7d2h/Kri-evci.jpg" alt="Kri-evci' },
  { id: 2, name: 'Odlagali≈°te otpada Koprivnica', image: 'https://i.ibb.co/5bKn04x/Koprivnica.png' },
  { id: 3, name: 'Odlagali≈°te otpada Virovitica', image: 'https://i.ibb.co/KjTGQsfH/Virovitica-novo.jpg' },
  { id: 4, name: 'Odlagali≈°te otpada Grubi≈°no Polje', image: 'https://i.ibb.co/Mj4QH3G/Grubi-no-Polje-mapa-novo.jpg' },
  { id: 5, name: 'Odlagali≈°te otpada Beli≈°ƒáe', image: 'https://i.ibb.co/fV9kV9KL/Beli-e-novo.jpg" alt="Beli' },
  { id: 6, name: 'Odlagali≈°te otpada Beli Manastir', image: 'https://i.ibb.co/KxkNtJ77/Beli-Manastir.jpg' },
  { id: 7, name: 'Odlagali≈°te otpada Pag', image: 'https://i.ibb.co/jk95HgmT/Pag.png" alt="Pag"' },
  { id: 8, name: 'Odlagali≈°te otpada Otoƒçac', image: 'https://i.ibb.co/RTRncf9H/Oto-ac.png" alt="Oto-ac' },
  { id: 9, name: 'Odlagali≈°te otpada Zadar - Diklo', image: 'https://i.imgur.com/tI4O4vQ.jpeg' },
  { id: 10, name: 'Odlagali≈°te otpada Split - Karepovac', image: 'https://i.ibb.co/tPT8v5rP/Karepovac.png"' },
  { id: 11, name: 'Odlagali≈°te otpada Knin - Mala Promina', image: 'https://i.ibb.co/KcMFgVwD/Knin.png" alt="Knin"' },
  { id: 12, name: 'Odlagali≈°te otpada Kljakovaƒça - Obrovac', image: 'https://i.ibb.co/7JjzKsB4/Obrovac.png' }
];
const state = {
  selectedLandfill: null,
  currentMeasurer: "",
  currentDevice: "",
  currentMeasurement: {
    measurer: '',
    device: '',
    landfill: null,
    date: new Date().toISOString().split('T')[0],
    airTemp: '',
    airPressure: '',
    windDirection: '',
    windSpeed: '',
    pipeDiameter: '',
    startTime: '',
    vents: []
  },
  editingIndex: -1,
  editingVentIndex: -1
};
function showScreen(id) {
  document.querySelectorAll('.screen').forEach(s => s.style.display = 'none');
  document.getElementById(id).style.display = 'block';
}
function resetToLogin() {
  if (confirm("Jeste li sigurni da ≈æelite napustiti unos? Neƒáe biti spremljeno.")) {
    state.currentMeasurer = "";
    state.currentDevice = "";
    state.selectedLandfill = null;
    state.editingIndex = -1;
    state.editingVentIndex = -1;
    state.currentMeasurement = {
      measurer: '',
      device: '',
      landfill: null,
      date: new Date().toISOString().split('T')[0],
      airTemp: '',
      airPressure: '',
      windDirection: '',
      windSpeed: '',
      pipeDiameter: '',
      startTime: '',
      vents: []
    };
    showScreen('login-screen');
  }
}
function initLandfillGrid() {
  const grid = document.getElementById('landfill-grid');
  grid.innerHTML = '';
  state.selectedLandfill = null;
  LANDFILLS.forEach(landfill => {
    const card = document.createElement('div');
    card.className = 'landfill-card';
    card.innerHTML = `
    <img src="${landfill.image}" alt="${landfill.name}">
      <h3>${landfill.name}</h3>
    `;
    card.addEventListener('click', () => {
      document.querySelectorAll('.landfill-card').forEach(c => c.classList.remove('selected'));
      card.classList.add('selected');
      state.selectedLandfill = landfill;
    });
    grid.appendChild(card);
  });
}
function showVentForm() {
  openVentSelectModal();
}
function openVentSelectModal() {
  const modal = document.getElementById('vent-select-modal');
  const dropdown = document.getElementById('vent-select-dropdown');
  dropdown.innerHTML = '<option value="">Odaberi odu≈°nik</option>';
  let ventNames = [];
  if (state.selectedLandfill && VENTS_BY_LANDFILL[state.selectedLandfill.id]) {
    ventNames = VENTS_BY_LANDFILL[state.selectedLandfill.id];
  }
  const usedVents = state.currentMeasurement.vents.map(v => v.name);
  ventNames.filter(name => !usedVents.includes(name)).forEach(name => {
    const opt = document.createElement('option');
    opt.value = name;
    opt.textContent = name;
    dropdown.appendChild(opt);
  });
  modal.style.display = 'flex';
}
function closeVentSelectModal() {
  document.getElementById('vent-select-modal').style.display = 'none';
}
function openManualVentModal() {
  document.getElementById('manual-vent-input').value = '';
  document.getElementById('manual-vent-modal').style.display = 'flex';
}
function closeManualVentModal() {
  document.getElementById('manual-vent-modal').style.display = 'none';
}
document.addEventListener('DOMContentLoaded', function() {
  document.getElementById('vent-select-confirm').onclick = function() {
    const dropdown = document.getElementById('vent-select-dropdown');
    const selected = dropdown.value;
    if (!selected) {
      alert("Odaberite odu≈°nik!");
      return;
    }
    document.getElementById('vent-name').value = selected;
    document.getElementById('vent-index').value = -1;
    document.getElementById('vent-form').reset();
    document.getElementById('vent-name').value = selected;
    document.getElementById('vent-form').style.display = 'block';
    closeVentSelectModal();
  };
  document.getElementById('manual-vent-open').onclick = function(e) {
    e.preventDefault();
    closeVentSelectModal();
    openManualVentModal();
  };
  document.getElementById('manual-vent-confirm').onclick = function() {
    const name = document.getElementById('manual-vent-input').value.trim();
    if (!name) {
      alert("Unesi naziv novog odu≈°nika!");
      return;
    }
    document.getElementById('vent-name').value = name;
    document.getElementById('vent-index').value = -1;
    document.getElementById('vent-form').reset();
    document.getElementById('vent-name').value = name;
    document.getElementById('vent-form').style.display = 'block';
    closeManualVentModal();
  };
});
function editVent(index) {
  const vent = state.currentMeasurement.vents[index];
  if (!vent) return;
  state.editingVentIndex = index;
  document.getElementById('vent-name').value = vent.name;
  document.getElementById('ch4').value = vent.ch4 || '';
  document.getElementById('co2').value = vent.co2 || '';
  document.getElementById('o2').value = vent.o2 || '';
  document.getElementById('h2').value = vent.h2 || '';
  document.getElementById('h2s').value = vent.h2s || '';
  document.getElementById('vent-temp').value = vent.temp || '';
  document.getElementById('vent-note').value = vent.note || '';
  if (vent.status === 'measured') {
    document.getElementById('status-measured').checked = true;
  } else {
    document.getElementById('status-not-measurable').checked = true;
  }
  document.getElementById('vent-index').value = index;
  document.getElementById('vent-form').style.display = 'block';
}
function saveVentData() {
  const status = document.querySelector('input[name="vent-status"]:checked').value;
  const ventIndex = parseInt(document.getElementById('vent-index').value);
  const vent = {
    name: document.getElementById('vent-name').value,
    ch4: document.getElementById('ch4').value,
    co2: document.getElementById('co2').value,
    o2: document.getElementById('o2').value,
    h2: document.getElementById('h2').value,
    h2s: document.getElementById('h2s').value,
    temp: document.getElementById('vent-temp').value,
    status: status,
    note: document.getElementById('vent-note').value
  };
  if (!vent.name) {
    alert("Unesite naziv odu≈°nika!");
    return;
  }
  if (status === "measured") {
    if (vent.ch4 === "" || vent.co2 === "" || vent.o2 === "" || 
        vent.h2 === "" || vent.h2s === "" || vent.temp === "") {
      alert("Za izmjereni odu≈°nik morate unijeti sve podatke!");
      return;
    }
  }
  if (ventIndex >= 0) {
    state.currentMeasurement.vents[ventIndex] = vent;
  } else {
    state.currentMeasurement.vents.push(vent);
  }
  updateVentTable();
  document.getElementById('vent-form').reset();
  document.getElementById('vent-form').style.display = 'none';
  updateMissingVentsWarning();
}
function updateVentTable() {
  const ventList = document.getElementById('vent-list');
  ventList.innerHTML = '';
  state.currentMeasurement.vents.forEach((vent, index) => {
    const row = document.createElement('tr');
    row.innerHTML = `
      <td>${vent.name}</td>
      <td>${vent.ch4 || '-'}</td>
      <td>${vent.co2 || '-'}</td>
      <td>${vent.o2 || '-'}</td>
      <td>${vent.h2 || '-'}</td>
      <td>${vent.h2s || '-'}</td>
      <td>${vent.temp || '-'}</td>
      <td>${vent.status === 'measured' ? 'Izmjeren' : 'Ne mo≈æe se izmjeriti'}</td>
      <td>${vent.note || '-'}</td>
    `;
    row.addEventListener('click', () => editVent(index));
    ventList.appendChild(row);
  });
}
function updateMissingVentsWarning() {
  const landfillId = state.selectedLandfill ? state.selectedLandfill.id : null;
  let requiredVents = [];
  if (landfillId && VENTS_BY_LANDFILL[landfillId]) {
    requiredVents = VENTS_BY_LANDFILL[landfillId];
  }
  const enteredVents = state.currentMeasurement.vents.map(v => v.name);
  const missingVents = requiredVents.filter(name => !enteredVents.includes(name));
  const warningDiv = document.getElementById('missing-vents-warning');
  if (missingVents.length > 0) {
    warningDiv.innerHTML = "Nisu uneseni svi odu≈°nici! Nedostaju: <strong>" + missingVents.join(", ") + "</strong>";
    warningDiv.style.display = "block";
  } else {
    warningDiv.style.display = "none";
  }
}
function finishMeasurement() {
  const landfillId = state.selectedLandfill ? state.selectedLandfill.id : null;
  let requiredVents = [];
  if (landfillId && VENTS_BY_LANDFILL[landfillId]) {
    requiredVents = VENTS_BY_LANDFILL[landfillId];
  }
  const enteredVents = state.currentMeasurement.vents.map(v => v.name);
  const missingVents = requiredVents.filter(name => !enteredVents.includes(name));
  if (missingVents.length > 0) {
    updateMissingVentsWarning();
    alert("UPOZORENJE: Nisu uneseni svi odu≈°nici! Nedostaju: " + missingVents.join(", "));
    return;
  }
  document.getElementById('missing-vents-warning').style.display = "none";
  saveMeasurement();
  const successMessage = document.getElementById('success-message');
  successMessage.style.display = 'block';
  setTimeout(() => {
    successMessage.style.display = 'none';
    updateHistoryList();
    showScreen('measurement-history');
  }, 2000);
}
function saveMeasurement() {
  const measurements = JSON.parse(localStorage.getItem('measurements') || '[]');
  if (state.editingIndex >= 0) {
    measurements[state.editingIndex] = {...state.currentMeasurement};
    state.editingIndex = -1;
  } else {
    measurements.push({...state.currentMeasurement});
  }
  localStorage.setItem('measurements', JSON.stringify(measurements));
}
function loadMeasurements() {
  return JSON.parse(localStorage.getItem('measurements') || '[]');
}
function updateHistoryList() {
  const historyList = document.getElementById('history-list');
  historyList.innerHTML = '';
  const measurements = loadMeasurements();
  if (measurements.length === 0) {
    historyList.innerHTML = '<p>Nema spremljenih mjerenja</p>';
    return;
  }
  measurements.forEach((measurement, index) => {
    const item = document.createElement('div');
    item.className = 'history-item';
    item.innerHTML = `
      <h3>${measurement.landfill.name}</h3>
      <p><strong>Datum:</strong> ${measurement.date}</p>
      <p><strong>Mjeritelj:</strong> ${measurement.measurer}</p>
      <p><strong>Ureƒëaj:</strong> ${measurement.device}</p>
      <p><strong>Broj odu≈°nika:</strong> ${measurement.vents.length}</p>
      <div class="button-group">
        <button onclick="editMeasurement(${index})">Uredi</button>
        <button onclick="exportMeasurement(${index})">Preuzmi Excel</button>
        <button onclick="deleteMeasurement(${index})" style="background:#c0392b;">Obri≈°i</button>
      </div>
    `;
    historyList.appendChild(item);
  });
}
function deleteMeasurement(index) {
  if (!confirm("Jeste li sigurni da ≈æelite obrisati ovo mjerenje?")) return;
  let measurements = loadMeasurements();
  measurements.splice(index, 1);
  localStorage.setItem('measurements', JSON.stringify(measurements));
  updateHistoryList();
}
function editMeasurement(index) {
  const measurements = loadMeasurements();
  const measurement = measurements[index];
  state.editingIndex = index;
  state.currentMeasurement = {...measurement};
  document.getElementById('measurer-select').value = state.currentMeasurement.measurer;
  document.getElementById('device-select').value = state.currentMeasurement.device;
  renderDeviceDropdown();
  state.selectedLandfill = state.currentMeasurement.landfill;
  document.getElementById('measurement-date').value = state.currentMeasurement.date;
  document.getElementById('air-temp').value = state.currentMeasurement.airTemp;
  document.getElementById('air-pressure').value = state.currentMeasurement.airPressure;
  document.getElementById('wind-direction').value = state.currentMeasurement.windDirection;
  document.getElementById('wind-speed').value = state.currentMeasurement.windSpeed;
  document.getElementById('pipe-diameter').value = state.currentMeasurement.pipeDiameter;
  if (state.currentMeasurement.startTime) {
    const [hour, minute] = state.currentMeasurement.startTime.split(':');
    document.getElementById('start-hour').value = hour;
    document.getElementById('start-minute').value = minute;
  } else {
    document.getElementById('start-hour').value = '';
    document.getElementById('start-minute').value = '';
  }
  document.getElementById('measurement-submit-btn').textContent = 'Spremi promjene';
  showScreen('new-measurement');
}
function exportMeasurement(index) {
  const measurements = loadMeasurements();
  const measurement = measurements[index];
  const aoa = [
    ["", "Zapis (Oznaka obrasca - Broj izvje≈°taja )", "", "", "", "", "", "", "", "", ""],
    ["", "ZM-05-G", "", "", "", "", "", "", "", "", ""],
    ["", "", "", "", "", "", "", "", "", "", ""],
    ["", "Lokacija i naziv odlagali≈°ta:", measurement.landfill ? measurement.landfill.name : "", "", "", "", "List: ", "1/1", "", ""],
    ["", "Adresa:", "", "", "", "", "Datum:", measurement.date || "", "", ""],
    ["", "", "", "", "", "", "", "", "", "", ""],
    ["", "Mjeritelj:", measurement.measurer || "", "", "", "", "Kori≈°teni ureƒëaj za mjerenje:", measurement.device || "", "", ""],
    ["", "", "", "", "", "", "", "", "", "", ""],
    ["", "Temperatura zraka:", measurement.airTemp || "", "", "Smjer vjetra:", measurement.windDirection || "", "", "Promjer cijevi:", measurement.pipeDiameter || "", ""],
    ["", "Tlak zraka:", measurement.airPressure || "", "", "Brzina vjetra:", measurement.windSpeed || "", "", "Poƒçetak mjerenja:", measurement.startTime || "", ""],
    ["", "", "", "", "", "", "", "", "", "", ""],
    ["", "Odu≈°ak", "CH4 [%]", "CO2 [%]", "O2 [%]", "H2 [ppm]", "H2S [ppm]", "Temperatura odu≈°nika", "", "Status", "Napomena"]
  ];
  measurement.vents.forEach(vent => {
    aoa.push([
      "",
      vent.name,
      vent.ch4 || "",
      vent.co2 || "",
      vent.o2 || "",
      vent.h2 || "",
      vent.h2s || "",
      vent.temp || "",
      "",
      vent.status === 'measured' ? 'Izmjeren' : 'Ne mo≈æe se izmjeriti',
      vent.note || ""
    ]);
  });
  const ws = XLSX.utils.aoa_to_sheet(aoa);
  const wb = XLSX.utils.book_new();
  XLSX.utils.book_append_sheet(wb, ws, "Mjerenje");
  XLSX.writeFile(wb, `mjerenje_${measurement.date.replace(/-/g, '_')}.xlsx`);
}
function populateTimeDropdowns() {
  const hourSelect = document.getElementById('start-hour');
  const minuteSelect = document.getElementById('start-minute');
  hourSelect.innerHTML = '<option value="">Sat</option>';
  minuteSelect.innerHTML = '<option value="">Min</option>';
  for (let h = 0; h < 24; h++) {
    const val = h.toString().padStart(2, '0');
    hourSelect.innerHTML += `<option value="${val}">${val}</option>`;
  }
  for (let m = 0; m < 60; m += 5) {
    const val = m.toString().padStart(2, '0');
    minuteSelect.innerHTML += `<option value="${val}">${val}</option>`;
  }
}
function initApp() {
  const measurerSelect = document.getElementById('measurer-select');
  MEASURERS.forEach(m => {
    const option = document.createElement('option');
    option.value = m;
    option.textContent = m;
    measurerSelect.appendChild(option);
  });
  populateTimeDropdowns();
  document.getElementById('login-form').addEventListener('submit', e => {
    e.preventDefault();
    state.currentMeasurer = document.getElementById('measurer-select').value;
    state.currentDevice = document.getElementById('device-select').value;
    if (!state.currentMeasurer || !state.currentDevice) {
      alert("Odaberite mjeritelja i ureƒëaj za mjerenje!");
      return;
    }
    showScreen('template-landfill-screen');
    initLandfillGrid();
  });
  document.getElementById('go-to-history').addEventListener('click', () => {
    updateHistoryList();
    showScreen('measurement-history');
  });
  document.getElementById('template-landfill-next').addEventListener('click', () => {
    const warn = document.getElementById('template-landfill-warning');
    if (!state.selectedLandfill) {
      warn.textContent = "Niste odabrali odlagali≈°te!";
      warn.style.display = "block";
      return;
    }
    warn.style.display = "none";
    state.editingIndex = -1;
    state.editingVentIndex = -1;
    document.getElementById('measurement-submit-btn').textContent = 'Nastavi na unos odu≈°nika';
    state.currentMeasurement = {
      measurer: state.currentMeasurer,
      device: state.currentDevice,
      landfill: state.selectedLandfill,
      date: new Date().toISOString().split('T')[0],
      airTemp: '',
      airPressure: '',
      windDirection: '',
      windSpeed: '',
      pipeDiameter: '',
      startTime: '',
      vents: []
    };
    document.getElementById('measurement-date').value = state.currentMeasurement.date;
    document.getElementById('start-hour').value = '';
    document.getElementById('start-minute').value = '';
    showScreen('new-measurement');
  });
  document.getElementById('measurement-form').addEventListener('submit', e => {
    e.preventDefault();
    const hour = document.getElementById('start-hour').value;
    const minute = document.getElementById('start-minute').value;
    if (!hour || !minute) {
      alert("Odaberite vrijeme poƒçetka (sat i minuta)!");
      return;
    }
    state.currentMeasurement.date = document.getElementById('measurement-date').value;
    state.currentMeasurement.airTemp = document.getElementById('air-temp').value;
    state.currentMeasurement.airPressure = document.getElementById('air-pressure').value;
    state.currentMeasurement.windDirection = document.getElementById('wind-direction').value;
    state.currentMeasurement.windSpeed = document.getElementById('wind-speed').value;
    state.currentMeasurement.pipeDiameter = document.getElementById('pipe-diameter').value;
    state.currentMeasurement.startTime = `${hour}:${minute}`;
    document.getElementById('landfill-name-display').textContent = state.currentMeasurement.landfill.name;
    document.getElementById('landfill-map').src = state.currentMeasurement.landfill.image;
    updateVentTable();
    updateMissingVentsWarning();
    showScreen('vent-mapping');
  });
  document.getElementById('add-vent-btn').addEventListener('click', showVentForm);
  document.getElementById('vent-list').addEventListener('click', e => {
    const row = e.target.closest('tr');
    if (!row) return;
    const index = Array.from(row.parentNode.children).indexOf(row);
    editVent(index);
  });
  document.getElementById('vent-form').addEventListener('submit', e => {
    e.preventDefault();
    saveVentData();
  });
  document.getElementById('finish-measurement').addEventListener('click', finishMeasurement);
  updateHistoryList();
  showScreen('login-screen');
}
document.addEventListener('DOMContentLoaded', initApp);
</script>
</body>
</html>
